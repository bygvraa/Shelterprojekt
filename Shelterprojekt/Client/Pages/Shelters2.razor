@page "/"
@using Shelterprojekt.Shared.Models
@using Shelterprojekt.Shared.Validation
@inject HttpClient Http

<h3>Shelters</h3>

@if (ShelterList == null)
{
    <p><em>Indlæser shelters, vent venligst...</em></p>
    <br />

}
else
{
<div class="col-md-8">

    <table style="width: 100%; height: 100px; margin-bottom: 6px; display: table;">
        <tbody>
            <tr>
                <td>
                    @foreach (var shelter in ShelterList)
                    {
                        <table class="shelter-card">
                            <tbody class="shelter-card-tbody">
                                <tr class="shelter-card-row">

                                    <td class="shelter-card-cell" valign="top">
                                        <div style="font-weight: bold; font-size: 14px; margin-bottom: 3px; display: block;">
                                            @shelter.properties.navn
                                        </div>

                                        <div style="height:40px; display: table-cell;">
                                            <div style="display: block;">@shelter.properties.beskrivels</div>
                                        </div>

                                        <div style="display: inline-table">
                                            <div id="pladser" style="display: table-cell; padding-right: 20px">
                                                Antal pladser: @shelter.properties.antal_pl
                                            </div>
                                            <div id="handicap" style="display:table-cell">
                                                @shelter.properties.handicap
                                            </div>

                                        </div>


                                    </td>
                                    <td align="right" valign="middle" style="padding-right: 10px;">
                                        <button class="btn btn-info" style="width: 120px" @onclick="@(async () => await AddBooking(shelter.Id, shelter.properties.navn))">Book shelter</button>
                                    </td>

                                </tr>
                            </tbody>
                        </table>
                    }
                </td>
            </tr>
        </tbody>
    </table>
</div>

// Trykkes der på "book shelter"-knappen, ændres "isAdd" til true, og følgende kode køres:
    if (isAdd)
    {
        <EditForm  EditContext="@editContext" OnValidSubmit="@(async () => await SaveBooking())">
            <DataAnnotationsValidator />
            <ValidationSummary />

            <div class="modal" tabindex="-1" style="display:block" role="dialog">
                <div class="modal-dialog">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3 class="modal-title">@ModalTitle</h3>
                            <button type="button" class="close" @onclick="@this.CloseModal">
                                <span aria-hidden="true">x</span>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form>
                                <div class="form-group">


                                    <label for="brugernavn" style="width: 300px">
                                        Brugernavn
                                    </label>
                                            <InputText @bind-Value="@booking.brugerNavn" />
                                        <ValidationMessage For="@(() => booking.brugerNavn)" />


                                    <label for="dato" style="width: 300px; padding-top: 20px">
                                        Dato
                                    </label>
                                    <input type="date" min="@dateDisable"
                                           @bind-value="@booking.dato"
                                           @onmouseout="(async () => await CheckBooking(booking.shelterId, booking.dato))"
                                           @onblur="(async () => await CheckBooking(booking.shelterId, booking.dato))" />
                                        <ValidationMessage For="@(() => booking.dato)" />

                                </div>
                            </form>
                        </div>

                        <div class="modal-footer">
                            <p valigh="left" style="@messageStyles">
                                @message
                            </p>
                            <button type="submit" class="btn btn-primary" id="submitBtn" disabled="@formInvalid">Submit</button>
                        </div>

                    </div>
                </div>
            </div>
        </EditForm>

    }
}

@code {

    // Variabler --------------------------------------------
    //

    // Variabler, der bruges af kalenderen
    string dateDisable = DateTime.Now.ToString("yyyy-MM-dd");
    string dateValue;


    // Variabler til at indlæse booking- og shelter-listerne
    protected List<Booking> BookingList;
    protected List<Shelter> ShelterList;

    protected Booking booking = new() { dato = DateTime.Now };


    // Variabler, der bruges af data/form validation
    private EditContext editContext;
    private ValidationMessageStore messageStore;
    private bool formInvalid = true;

    private string message;
    private string messageStyles = "visibility:hidden";


    // Variabler, der bruges af modal (pop-up vinduet)
    protected string ModalTitle { get; set; }
    protected Boolean isAdd = false;



    // Metoder ----------------------------------------------
    //

    protected async Task GetBookings()
    {
        BookingList = await Http.GetJsonAsync<List<Booking>>("api/booking/index");
    }
    protected async Task GetShelters()
    {
        ShelterList = await Http.GetJsonAsync<List<Shelter>>("api/shelter/index");
    }


    protected async Task AddBooking(string id, string navn)
    {
        editContext = new(booking = new() { dato = DateTime.Now });
        editContext.SetFieldCssClassProvider(new CustomFieldClassProvider());
        messageStore = new(editContext);


        this.ModalTitle = "Book " + navn;
        this.isAdd = true;
        await GetBookings().ConfigureAwait(false);

        this.@booking.shelterId = id;
        this.@booking.shelterNavn = navn;

    }

    protected async Task SaveBooking()
    {
        if (booking.Id != null)
        {
            await Http.SendJsonAsync(HttpMethod.Put, "api/booking/edit", booking);
        }
        else
        {
            await Http.SendJsonAsync(HttpMethod.Post, "/api/booking/create", booking);
        }
        await GetBookings();

        //this.CloseModal();
        formInvalid = true;

        messageStyles = "color:green";
        message = "Booking af shelter er nu gennemført";

    }

    protected async Task CheckBooking(string id, DateTime date)
    {
        string dateString = date.ToLongDateString();

        // Console.WriteLine(id + ": " + dateString);
        // Console.WriteLine("her: "+ date);


        messageStore.Clear();
        CloseMessage();

        if ( await Http.GetJsonAsync<bool>("api/booking/check/" + id + "/" + dateString) == true)
        {
            formInvalid = true;
            messageStore.Add(() => booking.dato, "Booking er ikke mulig på denne dato, vælg venligst en anden");
        }
        else
        {
            formInvalid = false;
            dateValue = date.ToString("yyyy-MM-dd");

        }


    }


    protected void CloseModal()
    {
        this.isAdd = false;
        CloseMessage();
    }

    protected void CloseMessage()
    {
        messageStyles = "visibility:hidden";
    }

    protected override async Task OnInitializedAsync()
    {
        await GetBookings();
        await GetShelters();

    }


}
